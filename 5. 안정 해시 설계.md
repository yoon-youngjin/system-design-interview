## 안정 해시 설계

수평적 규모 확정성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 안정 해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

### 해시 키 재배치(rehash) 문제 

N개의 캐시 서버가 있다고 하자. 이 서버들에 부하를 균등하게 나누는 보편적 방법은 아래의 해시 함수를 사용하는 것이다.

**serverIndex = hash(key) % N**

이 방법은 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다. 하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

### 안정 해시 (Consistent Hash)

안정 해시는 해시 테이블의 크기가 조정될 때 평균적으로 k/n개의 키만 재배치하는 해시 기술이다. (k = 키의 개수, n = 슬롯 개수)

![image](https://user-images.githubusercontent.com/83503188/235918231-5c74d898-a584-44ce-8cb0-5d4edcb4e957.png)
- 해시 함수의 출력 값 범위를 기반으로 해시 링을 만든다.

![image](https://user-images.githubusercontent.com/83503188/235917979-e64bedda-d24d-4df4-8a30-4d3852fcfdd1.png)
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다.

![image](https://user-images.githubusercontent.com/83503188/235918364-91b26232-a8cb-4bc6-93f6-b0c424b36b61.png)
- 서버를 추가하더라도 키 가운데 일부만 재배치하면 된다.

**안정 해시의 문제점**
- 서버가 추가되거나 삭제되는 상황을 감안하면 파티션(인접한 서버 사이의 해시 공간)의 크기를 균등하게 유지하는 게 불가능하다.
- 특정 상황에 따라 키가 균등하게 분포되지 않을 수도 있다. 

이 문제를 해결하기 위해 제안된 기법이 가상 노드 또는 복제라 불리는 기법이 존재한다.

**안정 해시의 이점**
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟(유명인사) 키 문제를 줄인다. 안정 해시는 데이터를 좀 더 균등하게 분배하므로 이런 문제가 생길 가능성을 줄인다.





